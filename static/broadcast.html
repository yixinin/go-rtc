<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>广播</title>
    <style>
        video {
            width: 320px;
            height: 240px;
            border: 1px solid black;
        }

        div {
            display: inline-block;
        }
    </style>
</head>

<body>
    <script></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>

    <script src="https://webrtc.github.io/adapter/adapter.js" type="text/javascript"></script>

    <script>

        var randUid = Math.floor(Math.random() * 10000 + 1);
        var cands = new Array()

        var signalingChannel, key, id,
            haveLocalMedia = false,
            weWaited = false,
            video1Stream, video1,
            video2Stream, video2,
            doNothing = function () { },
            pc,
            constraints = {
                mandatory: {
                    OfferToReceiveAudio: true,
                    OfferToReceiveVideo: true
                }
            }

        var log = msg => {
            document.getElementById('logs').innerHTML += msg + '<br>'
        }

        //发送offer
        function send_offer(offer) {
            var req = {
                offer: offer.sdp,
                uid: randUid
            }

            $.post('/getAnswer',
                req,
                function (data, status) {
                    console.log("get answer " + status);
                    if (data) {
                        var answer = {
                            sdp: data,
                            type: "answer"
                        }
                        pc.setRemoteDescription(new RTCSessionDescription(answer))
                    }
                });


        }

        //发送candidate
        function send_candidate(cand) {
            // for (let i in cands) {
            //     var req = {
            //         "uid": randUid,
            //         "candidate": cands[i]
            //     }
            //     console.log(cands[i])
            //     post('/sendCandidate', req);
            // }
            var req = {
                    "uid": randUid,
                    "candidate": cand
                }
                console.log(cand)
                post('/sendCandidate', req);

        }

        function post(r, opt) {
            $.ajax({
                type: "post",
                url: r,
                dataType: "json",
                //contentType : "application/json",      //网上很多介绍加上此参数的，后来我发现不加入这个参数才会请求成功。
                data: JSON.stringify(opt),
                success: function (d) {
                    console.log(d);
                }
            });
        }
        // 获取本地媒体
        function getMedia() {
            (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia)({
                audio: true,
                video: true
            }, gotUserMedia, didntGetUserMedia)
        }
        function didntGetUserMedia() {
            console.log('cound not get user media')
        }
        function gotUserMedia(stream) {
            video1Stream = stream
            haveLocalMedia = true
            // 向我显示我的本地视频
            video1.srcObject = video1Stream
            // 等待pc创建完毕
            attachMediaIfReady()
        }

        // 创建对等连接，即实例化peerConnection
        function createPC() {

            config = new Array();
            config.push({
                url: 'stun:stun.ideasip.com'
            })
            config.push({
                url: 'stun:stun.voipgate.com:3478'
            })

            console.log('config: ', JSON.stringify(config))
            pc = new RTCPeerConnection({
                iceServers: config,
                sdpSemantics: 'unified-plan',
                // sdpSemantics: 'plan-b',
            })
            pc.onicecandidate = onIceCandidate
            // pc.onaddstream = onRemoteStreamAdded
            pc.ontrack = function(e){
                var el = document.getElementById("video2")
                el.srcObject = e.streams[0]
                el.autoplay=true
            }

            // 等待媒体就绪
            attachMediaIfReady()
        }

        // 如果当前浏览器有另一个候选项，将其发送给对等端
        function onIceCandidate(e) {
            if (e.candidate) {
                var cand = {
                    "sdpMid": e.candidate.sdpMid,
                    "sdpMlineindex": e.candidate.sdpMLineIndex,
                    "candidate": e.candidate.candidate
                }
                // if (cands.length == 0) {
                //     setTimeout("send_candidate()", "4000");
                // }
                // cands.push(cand)
                send_candidate(cand)
            }
        }

        // 如果我们浏览器检测到另一端加入了媒体流，则将其显示在屏幕上
        function onRemoteStreamAdded(e) {
            video2Stream = e.stream
            console.log('video: ', video2)
            video2.srcObject = video2Stream
        }

        // 远端移除流，这里不做操作
        function onRemoteStreamRemoved(e) {

        }

        function attachMediaIfReady() {
            if (pc && haveLocalMedia) attachMedia()
        }

        // 将本地流添加至对等连接
        function attachMedia() {
            console.log("add stream to peerconn")
            pc.addStream(video1Stream)
        }

        // 生成一个offer
        function pub() {
            document.getElementById('uid').innerText = "uid:" + randUid
            createPC()
            video1 = document.getElementById('video1')
            video2 = document.getElementById('video2')
            getMedia()

            pc.createOffer(gotDescription, doNothing, constraints)
        }
        function sub() {
            document.getElementById('uid').innerText = "uid:" + randUid
            createPC()
            video1 = document.getElementById('video1')
            video2 = document.getElementById('video2')
            pc.addTransceiver('video')
            pc.createOffer(gotDescription, doNothing, constraints)
        }

        // 应答会话描述，生成answer
        function answer() {
            pc.createAnswer(gotDescription, doNothing, constraints)
        }

        // 一旦获取到了会话描述，就将其作为本地描述，然后将其发送至另一端的浏览器
        function gotDescription(localDesc) {
            pc.setLocalDescription(localDesc)
            send_offer(localDesc)
        }
    </script>


    <br />

    Video<br />

    <p id="uid"></p>
    <video id="video1" width="160" height="120" autoplay muted></video> <br />
    <video id="video2" width="160" height="120", autoplay muted></video> <br />
    <button id="pub" onclick="pub()"> Publish a Broadcast </button>
    <button id="sub" onclick="sub()"> Join a Broadcast </button><br />

    <br />

    Logs<br />
    <div id="logs"></div>
</body>