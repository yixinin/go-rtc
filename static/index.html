<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>视频聊天</title>
    <style>
        video {
            width: 320px;
            height: 240px;
            border: 1px solid black;
        }

        div {
            display: inline-block;
        }
    </style>
</head>

<body>
    <!-- 次空白脚本转为查询参数预留 -->
    <script></script>

    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>

    <script src="https://webrtc.github.io/adapter/adapter.js" type="text/javascript"></script>

    <script type="text/javascript" src="/static/js/clientXHRSignaling.js"></script>

    <script>

        var randUid = Math.floor(Math.random() * 10000 + 1);
        var cands = new Array()

        var signalingChannel, key, id,
            haveLocalMedia = false,
            weWaited = false,
            v1VideoStream, v1Video,
            v2VideoStream, v2Video,
            doNothing = function () { },
            pc,
            constraints = {
                mandatory: {
                    OfferToReceiveAudio: true,
                    OfferToReceiveVideo: true
                }
            }

        // 自动开始获取本地媒体
        window.onload = function () {
            document.getElementById('uid').innerText = "uid:" + randUid
            v1Video = document.getElementById('v1Video')
            v2Video = document.getElementById('v2Video')
        }

        function getLocalVideo(fromUid) {
            createPC(fromUid)
        }
        //发送offer
        function send_offer(offer) {
            var fromUid = document.getElementById('fromUid').value

            var req = {
                offer: offer.sdp,
                fromUid: fromUid,
                uid: randUid
            }

            $.post('/getAnswer',
                req,
                function (data, status) {
                    console.log("get answer " + status);
                    if (data) {
                        var answer = {
                            sdp: data,
                            type: "answer"
                        }
                        pc.setRemoteDescription(new RTCSessionDescription(answer))
                    }
                });


        }

        //发送candidate
        function send_candidate() {
            for (let i in cands) {
                var req = {
                    "uid": randUid,
                    "candidate": cands[i]
                }
                // console.log(cands[i])
                post('/sendCandidate', req);
            }

        }

        function post(r, opt) {
            $.ajax({
                type: "post",
                url: r,
                dataType: "json",
                //contentType : "application/json",      //网上很多介绍加上此参数的，后来我发现不加入这个参数才会请求成功。
                data: JSON.stringify(opt),
                success: function (d) {
                    console.log(d);
                }
            });
        }
        // 获取本地媒体
        function getMedia(fromUid) {
            // (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia)({
            //     audio: true,
            //     video: true
            // }, gotUserMedia, didntGetUserMedia)
            if (fromUid == 0) {
                navigator.getUserMedia(
                    {
                        audio: true,
                        video: true
                    }, stream => {
                        v1VideoStream = stream
                        haveLocalMedia = true
                        v1Video.srcObject = v1VideoStream
                        if (pc) {
                            pc.addStream(v1VideoStream)
                            console.log("add local stream to pc (webcam)")
                        }
                    }, err => {
                        navigator.mediaDevices.getDisplayMedia({
                            video: true
                        }).then(stream => {
                            v1VideoStream = stream
                            haveLocalMedia = true
                            v1Video.srcObject = v1VideoStream
                            if (pc) {
                                pc.addStream(v1VideoStream)
                                console.log("add local stream to pc (screen)")
                            }

                        }, error => {
                            console.log("Unable to acquire screen capture", error);
                        });
                    }
                );
            }
            pc.addTransceiver('video')
        }


        // 创建对等连接，即实例化peerConnection
        function createPC(fromUid) {
            config = new Array();
            config.push({
                url: 'stun:stun.ideasip.com'
            })
            config.push({
                url: 'stun:stun.voipgate.com:3478'
            })

            console.log('config: ', JSON.stringify(config))
            pc = new RTCPeerConnection({
                iceServers: config,
                // sdpSemantics: 'plan-b',
                sdpSemantics: 'unified-plan',
            })
            pc.onicecandidate = onIceCandidate
            pc.onaddstream = onRemoteStreamAdded
            // pc.onremovestream = onRemoteStreamRemoved

            // 等待媒体就绪
            getMedia(fromUid)
        }

        // 如果当前浏览器有另一个候选项，将其发送给对等端
        function onIceCandidate(e) {
            if (e.candidate) {
                var cand = {
                    "sdpMid": e.candidate.sdpMid,
                    "sdpMlineindex": e.candidate.sdpMLineIndex,
                    "candidate": e.candidate.candidate
                }
                if (cands.length == 0) {
                    setTimeout("send_candidate()", "4000");
                }
                cands.push(cand)


            }
        }

        // 如果我们浏览器检测到另一端加入了媒体流，则将其显示在屏幕上
        function onRemoteStreamAdded(e) {
            v2VideoStream = e.stream
            // console.log('v2Video: ', v2Video)
            if (v1Video.srcObject) {
                v2Video.srcObject = v2VideoStream
            } else {
                v1Video.srcObject = v2VideoStream
            }

        }


        // 生成一个offer
        function call() {
            var fromUid = document.getElementById("fromUid").value
            getLocalVideo(fromUid)
            pc.createOffer(gotDescription, doNothing, constraints)
        }

        // 应答会话描述，生成answer
        function answer() {
            pc.createAnswer(gotDescription, doNothing, constraints)
        }

        // 一旦获取到了会话描述，就将其作为本地描述，然后将其发送至另一端的浏览器
        function gotDescription(localDesc) {
            pc.setLocalDescription(localDesc)
            send_offer(localDesc)
        }

    </script>

    <div id="setup">
        <p>WebRTC 视频聊天demo测试</p>

        <p id="uid"></p>
        <p>
            <input id="fromUid">
            <button id="call" onclick="call()">呼叫</button>
        </p>
    </div>

    <br />

    <div style="width:30%;vertical-align:top">
        <div>
            <video autoplay="autoplay" id="v1Video" controls muted="true" />
        </div>
    </div>

    <div style="width:30%;vertical-align:top;margin-left:200px;">
        <div>
            <video id="v2Video" autoplay="autoplay" controls muted="true" />
        </div>
    </div>


</body>

</html>